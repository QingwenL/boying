# 用户模块

## 注册

+ 校验验证码
+ 用户名,手机号是否唯一
+ 删除该验证码,防止重复使用

	

## 账号密码登录

+ 首先从缓存中通过`username`获取用户信息

+ 获取不到则查询数据库，并且将查到的存入缓存中（数据库也没有则报错给前端）

+ 将用户输入的密码与数据库查到的`user`对比（密码错误则报错给前端）

+ 在服务器内存中存储了该用户信息，返回`token`给前端

	

## 手机号密码登录

+ 首先从缓存中通过`telephone`获取用户信息
+ 获取不到则查询数据库，并且将查到的存入缓存中（数据库也没有则报错给前端）
+ 将用户输入的密码与数据库查到的`user`对比（密码错误则报错给前端）
+ 在服务器内存中存储了该用户信息，返回`token`给前端

## 手机号验证码登录

+ 首先校验验证码
+ 从缓存中通过`telephone`获取用户信息
+ 获取不到则查询数据库，并且将查到的存入缓存中
+ 在服务器内存中存储了该用户信息，返回`token`给前端

## 修改密码

+ 查询该手机号是否存在
+ 校验验证码
+ 删除该验证码,防止重复使用
+ 更新成功时删除无效缓存(删除两条,分别是{username:user},{telephone:user})

## 更新个人信息

+ 参数都是可选的参数
+ 更新成功时删除无效缓存

## 获取个人信息

没登录时会报错,否则返回当前登录用户的信息

## 获取验证码

+ 查询生成6位随机数
+ 用`redis`存储手机号,验证码,90秒过期
+ 用阿里云服务向手机号发送验证码

## 刷新token

+ 如果`token`过期或者在30分钟之内刚刷新过，则不进行操作
+ 否则通过原先的`token`的用户信息和当前的时间新生成一个`token`

# 菜单模块

## 查看菜单

# 演出模块

## 演出的综合搜索筛选


* 可根据以下的几种综合搜索演出:
* 关键词,城市,目录,时间
* 调用分页工具对返回结果进行分页:每页条数,分页数
* 搜索排序方式(0->按相关度；1->按推荐；2->按时间；3->最低价格从低到高；4->最低价格从高到低)

## 获取某个演出详情

+ 通过演出ID获取该演出信息,用于在进入特定的演出详情页面

# 演出座次模块

## 获取某演唱会场次的所有座次

+ 根据showSessionId获取该演出场次的所有座次

## 获取演出座次详情

+ 根据演出座次ID获取演出座次详情


# 订单模块

## 用户下单（场次ID，支付方式）

一个用户对一个场次只能下单1次，但是可以选择不同座次的票，一个订单只用写一个常用联系人就行，而且限购5张

+ 查看该登录用户对于该场次的订单是否已经存在（已退票的不算）
+ 验证传入参数（演出座次要大于等于1，小于等于5）
+ 验证传入的演出场次是否存在
+ 验证传入的演出座次是否属于传入的演出场次
+ 查看所有传入的演出座次的库存状态是否不足
+ 对要下单的演出座次减库存
+ 
+ 生成订单，下单人为当前用户、设置演出场次、待观看状态（1）、时间、支付状态、user方面的删除、演出Id
+ 设置订单总数,订单总金额，生成订单，得到订单ID
+ 将信息写入票中（order_id,class_id），并且对票生成对应的二维码与信息

## 查看所有订单

订单状态：待观看（1）、已退票（3）

+ 先查询当前用户,再根据用户Id查询订单表
+ 可分类查询,共两类: 待评价,已完成
+ 支持订单名称（即演唱会名）模糊搜索，（支持对一个演唱会下几次单）
+ 支持分页查询

## 查看订单详情

+ 传入订单Id,获取当前用户,校验是否是该用户的订单
+ 返回订单本身的信息再查询出写的常用联系人详情
+ 再查询票的详情，一起返回，约定前后端格式

## 删除订单

+ 仅仅是用户层面的删除订单,即对用户隐藏
+ 传入订单Id,获取当前用户
+ 校验是否是该用户的订单（订单Id，当前用户Id，user_delete为false的）
+ 将该Id的user_delete设为true

## 取消订单

+ 获取当前用户
+ 获取订单（订单Id，当前用户Id，user_delete为false的）
+ 如果订单状态为已完成（2），则不能取消
+ 设置订单状态为已取消（3）

# 票模块

## 增加票

## 查看所有票

## 查看某张票

# 一些简化

## 订单流程简化

+ 没有购物车,订单也没有待付款的操作,用户选好票后直接付款就生成了订单。
+ 没有线下寄件的操作，用户订单生成后直接也只能可以查看电子票。
+ 订单只有待观看，已退票，已完成两种情况。

	